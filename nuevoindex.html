<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rotiser√≠a El Tachi</title>
  <link rel="icon" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>

  <!-- ============  ESTILOS  ============ -->
  <style>
    :root{
      --azul:#003366;
      --azul-2:#001122;
      --azul-3:#004080;
      --amarillo:#ffcc00;
      --gris-borde:#ccc;
      --bg:#f8f9fa;
      --text:#333;
      --card:#fff;
      --card-hover:#f1f1f1;
      --resumen-bg:#fff3cd;
      --resumen-borde:#ffeeba;
      --ok:#16a34a;
      --error:#dc2626;
      --shadow:0 10px 24px rgba(0,0,0,.18);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Roboto',sans-serif;background:var(--bg);color:var(--text)}

    /* ---------- Header ---------- */
    header{
      background:linear-gradient(90deg,var(--azul) 0%,var(--azul-2) 100%);
      color:#fff;text-align:center;padding:2rem 1rem
    }
    header img{max-height:180px;margin:0 auto 1rem}

    main{padding:1rem 1rem 112px;max-width:900px;margin:auto}

    /* ---------- Tabs ---------- */
    .tabs{display:flex;justify-content:center;gap:1rem;flex-wrap:wrap;margin-bottom:1rem}
    .tabs button{
      padding:.8rem 1.8rem;font-size:1.1rem;border:none;border-radius:30px;
      background:var(--azul-3);color:var(--amarillo);font-weight:bold;
      box-shadow:0 3px 8px rgba(0,0,0,.2);cursor:pointer;transition:.3s;border:2px solid transparent
    }
    .tabs button:hover{background:#0055aa}
    .tabs button.active{background:var(--azul-2);border-color:var(--amarillo);box-shadow:0 4px 12px rgba(0,0,0,.3)}

    /* --- Estado secci√≥n cerrada (Opci√≥n B) --- */
    .tab-closed{opacity:.55; cursor:not-allowed; filter:grayscale(60%)}
    .tab-closed::after{content:' (CERRADO)'; font-weight:800}
    .seccion-closed-overlay{
      padding:1rem; border:1px dashed #f59e0b; border-radius:10px;
      margin:.5rem 0 1rem; background:#fff8e1; color:#7a4c00;
      font-size:1.05rem; text-align:center; font-weight:600;
    }

    /* ---------- Listados ---------- */
    details{border:1px solid var(--gris-borde);border-radius:8px;margin-bottom:1rem;overflow:hidden;background:var(--card)}
    summary{background:var(--azul);color:var(--amarillo);padding:1rem;cursor:pointer;font-weight:bold;font-size:1.1rem;user-select:none;list-style:none}

    .producto{
      display:flex;justify-content:space-between;align-items:center;gap:.75rem;
      padding:.5rem 1rem;border-top:1px solid #ddd;background:var(--card);transition:background .2s
    }
    .producto:hover{background:var(--card-hover)}
    .producto-info{max-width:65%}
    .producto h3{margin:.2rem 0;color:#004c99;font-size:1rem}
    .producto p{margin:.1rem 0;font-size:.9rem;color:var(--text)}

    .contador{display:flex;align-items:center;gap:.5rem}
    .contador button{
      background:var(--azul);color:var(--amarillo);border:none;padding:.3rem .6rem;
      font-weight:bold;font-size:1.2rem;cursor:pointer;border-radius:5px;transform-origin:center
    }
    @keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
    .btn-pop{animation:pop .22s ease-out}
    @keyframes flash{0%,100%{box-shadow:0 0 0 rgba(255,204,0,0)}50%{box-shadow:0 0 0 4px rgba(255,204,0,.35)}}
    .row-flash{animation:flash .35s ease-out}

    /* ---------- Precios de promos ---------- */
    .promo-badge{
      background:#ffef99;color:#7a4c00;border:1px solid #ffd84d;
      padding:.15rem .45rem;border-radius:999px;font-size:.8rem;font-weight:800;margin-left:.4rem
    }
    .price-wrap{display:flex;align-items:center;gap:.45rem;margin-top:.15rem}
    .price-old{text-decoration:line-through;opacity:.6;font-weight:700}
    .price-new{font-weight:900;color:#0b376d}

    /* ---------- Resumen ---------- */
    #resumen{background:var(--resumen-bg);border:1px solid var(--resumen-borde);border-radius:8px;padding:1rem}
    #resumen h3{margin-top:0}
    .resumen-empty{margin:.25rem 0 .5rem;opacity:.8}
    .resumen-list{list-style:none;padding:0;margin:.5rem 0 1rem;display:grid;gap:.35rem}
    .resumen-item{
      display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:.6rem;
      background:#fff;border:1px solid var(--gris-borde);border-radius:8px;padding:.5rem .6rem
    }
    .resumen-name{font-weight:700;color:#0b376d}
    .resumen-qty{opacity:.85;min-width:42px;text-align:right}
    .resumen-line{font-weight:700;min-width:88px;text-align:right}
    .totales{display:grid;gap:.25rem;margin-top:.5rem}
    .tot-line{display:flex;justify-content:space-between;align-items:center;padding:.35rem .2rem}
    .tot-line.total{font-size:1.1rem;font-weight:800;border-top:1px dashed #d6d6d6;margin-top:.25rem;padding-top:.5rem}
    #resumen .acciones{display:flex;gap:.75rem;flex-wrap:wrap}
    #resumen button{
      background:var(--azul);color:var(--amarillo);border:none;border-radius:5px;
      padding:.8rem 1.2rem;font-weight:bold;font-size:1rem;cursor:pointer
    }
    #btn-vaciar{background:#fff;color:#333;border:1px solid var(--gris-borde)}
    #btn-whatsapp:disabled{opacity:.6;cursor:not-allowed}

    /* ---------- Inputs ---------- */
    label{display:block;margin-top:1rem;font-weight:700}
    label input[type="text"],input[type="email"],input[type="tel"]{
      width:100%;padding:.95rem 1rem;font-size:1.05rem;border:1px solid var(--gris-borde);
      border-radius:12px;outline:none;background:#fff;transition:box-shadow .15s,border-color .15s
    }
    label input[type="text"]:focus{border-color:#7aa2ff;box-shadow:0 0 0 3px rgba(122,162,255,.25)}
    @media(max-width:520px){
      label{font-size:1.05rem}
      label input{padding:1.05rem 1rem;font-size:1.125rem;border-radius:14px}
      label input::placeholder{font-size:1.05rem}
    }

    /* ---------- FAB ---------- */
    .cart-fab{
      position:fixed;right:16px;bottom:calc(18px + env(safe-area-inset-bottom));z-index:99;
      background:var(--azul);color:var(--amarillo);border:2px solid var(--amarillo);
      display:flex;align-items:center;gap:.6rem;padding:.7rem 1.1rem;border-radius:9999px;
      font-size:1.05rem;box-shadow:0 8px 20px rgba(0,0,0,.25);cursor:pointer;
      user-select:none;touch-action:manipulation;-webkit-tap-highlight-color:transparent;
      transition:transform .15s,opacity .18s,filter .18s
    }
    .cart-fab *{pointer-events:none}
    .cart-fab:hover{transform:translateY(-2px)}
    .cart-fab.hide{opacity:0;transform:translateY(8px);filter:blur(2px);pointer-events:none}
    .cart-fab[hidden]{display:none}
    .cart-total{font-weight:700;font-size:1rem}
    .cart-count{
      background:var(--amarillo);color:var(--azul-2);min-width:26px;height:26px;border-radius:999px;
      display:grid;place-items:center;font-weight:800;font-size:.9rem
    }

    /* ---------- Toasts ---------- */
    .toast-wrap{
      position:fixed;left:50%;bottom:84px;transform:translateX(-50%);
      z-index:100;display:flex;flex-direction:column;gap:.5rem;pointer-events:none
    }
    .toast{
      pointer-events:auto;background:#0b1f3a;color:#fff;border-left:4px solid var(--azul-3);
      padding:.7rem 1rem;border-radius:8px;box-shadow:0 10px 24px rgba(0,0,0,.25);
      animation:fadeIn .18s ease-out;max-width:calc(100vw - 40px)
    }
    .toast.ok{border-left-color:var(--ok)}
    .toast.err{border-left-color:var(--error)}
    .toast.warn{border-left-color:#ffb400}
    @keyframes fadeIn{from{opacity:0;transform:translate(-50%,10px)}to{opacity:1;transform:translate(-50%,0)}}

    /* ---------- Divider ---------- */
    .section-divider{
      margin:2rem auto 0;max-width:900px;padding:0 1rem;height:12px;border-radius:999px;
      background:linear-gradient(to right,rgba(0,0,0,0)0%,#cbd5e1 18%,#94a3b8 50%,#cbd5e1 82%,rgba(0,0,0,0)100%);
      box-shadow:inset 0 2px 6px rgba(0,0,0,.08),0 8px 18px rgba(0,0,0,.06)
    }

    /* ---------- Promo footer ---------- */
    .promo-web{margin:1.2rem auto 0;max-width:900px;padding:1.2rem}
    .promo-card{
      background:linear-gradient(135deg,var(--azul)0%,#062247 100%);color:#fff;border-radius:16px;
      padding:1.2rem;box-shadow:0 18px 36px rgba(0,0,0,.25);display:grid;gap:1rem
    }
    .promo-card h3{margin:.2rem 0 .2rem;font-size:1.4rem}
    .promo-sub{margin:0;opacity:.9}
    .promo-badges{display:flex;flex-wrap:wrap;gap:.5rem}
    .badge{
      background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);
      color:#fff;padding:.35rem .6rem;border-radius:999px;font-size:.9rem;display:flex;align-items:center;gap:.35rem
    }
    .promo-actions{display:flex;flex-wrap:wrap;gap:.6rem}
    .btn{
      display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 1rem;border-radius:10px;
      font-weight:700;text-decoration:none;cursor:pointer;transition:transform .12s ease,opacity .12s ease;
      border:2px solid transparent
    }
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--amarillo);color:#001122;border-color:var(--amarillo)}
    .promo-note{font-size:.9rem;opacity:.9}

    /* ---------- Sheet ---------- */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.32);opacity:0;pointer-events:none;transition:opacity .22s ease;z-index:98}
    .sheet-backdrop.open{opacity:1;pointer-events:auto}
    .sheet{
      position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);
      background:var(--card);border-top-left-radius:16px;border-top-right-radius:16px;
      box-shadow:var(--shadow);transition:transform .28s ease-out;max-height:92vh;
      display:grid;grid-template-rows:auto 1fr;z-index:99
    }
    .sheet.open{transform:translateY(0)}
    .sheet-header{
      padding:.6rem .8rem .4rem;display:flex;align-items:center;gap:.5rem;
      position:sticky;top:0;background:var(--card);border-bottom:1px solid #e8e8e8;
      border-top-left-radius:16px;border-top-right-radius:16px
    }
    .sheet-handle{width:36px;height:4px;border-radius:999px;background:#d7d7d7;margin:.2rem auto;position:absolute;left:50%;transform:translateX(-50%);top:6px}
    .sheet-title{margin:0 auto 0 .4rem;font-size:1.05rem;font-weight:800;color:#0b376d}
    .sheet-close{margin-left:auto;background:#fff;border:1px solid #dcdcdc;border-radius:8px;padding:.35rem .6rem;cursor:pointer}
    .sheet-body{overflow:auto;padding:.8rem .9rem 1rem}

    @media(min-width:800px){
      .sheet{left:50%;right:auto;transform:translate(-50%,100%);width:720px;border-radius:16px}
      .sheet.open{transform:translate(-50%,0)}
    }

    /* ---------- Modal ---------- */
    .dialog-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;place-items:center;z-index:101}
    .dialog-backdrop.open{display:grid}
    .dialog{
      background:#fff;border-radius:14px;width:90%;max-width:340px;
      box-shadow:0 16px 32px rgba(0,0,0,.28);padding:1.4rem 1.2rem;text-align:center;
      animation:popin .24s ease-out
    }
    .dialog h3{margin:.2rem 0 1rem;font-size:1.25rem;color:#0b376d}
    .dialog p{margin:0 0 1.2rem}
    .dialog-actions{display:flex;gap:.8rem;justify-content:center;flex-wrap:wrap}
    .dialog-actions .btn{flex:1 1 120px}

    /* ---------- Admin bar ---------- */
    #adminBar{display:none !important}
    body.is-admin #adminBar{display:flex !important}
  </style>
</head>
<body>
  <!-- ============  ESTRUCTURA HTML  ============ -->
  <header>
    <img src="logo.png" alt="Rotiser√≠a El Tachi">
    <h1>Rotiser√≠a El Tachi</h1>
    <p>¬°Hac√© tu pedido desde la web!</p>
  </header>

  <main>
    <div class="tabs">
      <button id="btn-rotiseria" class="active" onclick="mostrar('rotiseria')">üçï Rotiser√≠a</button>
      <button id="btn-almacen"  onclick="mostrar('almacen')">üõçÔ∏è Almac√©n</button>
    </div>

    <div id="menu-rotiseria"></div>
    <div id="menu-almacen" style="display:none"></div>
  </main>

  <!-- FAB -->
  <button id="cartFab" type="button" class="cart-fab" hidden title="Ver pedido" aria-label="Ver pedido">
    <span class="cart-icon">üõí</span>
    <span class="cart-total" id="fabTotal">$ 0</span>
    <span class="cart-count" id="fabCount">0</span>
  </button>

  <!-- Divider -->
  <div class="section-divider" aria-hidden="true"></div>

  <!-- Promo footer -->
  <section id="promoWeb" class="promo-web" aria-labelledby="promo-web-title">
    <div class="promo-card">
      <div>
        <h3 id="promo-web-title">¬øQuer√©s una web como esta para tu negocio?</h3>
        <p class="promo-sub">Sitios r√°pidos, listos para vender y f√°ciles de editar.</p>
      </div>

      <div class="promo-badges">
        <span class="badge">‚ö° Entrega r√°pida</span>
        <span class="badge">üì± 100% responsive</span>
        <span class="badge">üõí Panel para productos</span>
        <span class="badge">üîí Hosting & dominio opcional</span>
        <span class="badge">üí¨ Soporte por email</span>
      </div>

      <div class="promo-actions">
        <a id="promoMail" class="btn btn-primary" href="#">‚úâÔ∏è Ped√≠ tu presupuesto</a>
      </div>

      <p class="promo-note">Creado por <strong>Ludmila Mercado</strong></p>
    </div>
  </section>

  <!-- Barra admin -->
  <div id="adminBar" hidden style="position:fixed;left:12px;bottom:16px;z-index:1000;display:flex;gap:.5rem;flex-wrap:wrap">
    <button id="exportOrdersBtn"  style="background:#fff;border:1px solid #ddd;padding:.45rem .6rem;border-radius:8px;box-shadow:0 6px 16px rgba(0,0,0,.18);font-size:.85rem;cursor:pointer;">üì• Exportar pedidos WSP (CSV)</button>
    <button id="exportSummaryBtn" style="background:#fff;border:1px solid #ddd;padding:.45rem .6rem;border-radius:8px;box-shadow:0 6px 16px rgba(0,0,0,.18);font-size:.85rem;cursor:pointer;">üìä Exportar top productos (CSV)</button>
    <button id="clearMetricsBtn"   style="background:#fff;border:1px solid #ddd;padding:.45rem .6rem;border-radius:8px;box-shadow:0 6px 16px rgba(0,0,0,.18);font-size:.85rem;cursor:pointer;">üóë Limpiar m√©tricas</button>
  </div>

  <!-- Toasts -->
  <div id="toastWrap" class="toast-wrap"></div>

  <!-- Bottom-sheet del carrito -->
  <div id="sheetBackdrop" class="sheet-backdrop" aria-hidden="true"></div>
  <div id="cartSheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" aria-hidden="true">
    <div class="sheet-header">
      <span class="sheet-handle" aria-hidden="true"></span>
      <h3 id="sheetTitle" class="sheet-title">Tu pedido</h3>
      <button id="sheetClose" type="button" class="sheet-close" aria-label="Cerrar">‚úï</button>
    </div>

    <div id="sheetBody" class="sheet-body" tabindex="0">
      <section id="checkout">
        <!-- radios SIN preselecci√≥n -->
        <label><input type="radio" name="envio" value="retiro"> Retiro en el local</label>
        <label><input type="radio" name="envio" value="envio"> Env√≠o a domicilio (+$1000)</label>

        <label>Nombre:
          <input type="text" id="nombre" placeholder="Tu nombre">
        </label>

        <label>Direcci√≥n:
          <input type="text" id="direccion" placeholder="Calle, n√∫mero, piso/depto">
        </label>

        <div id="resumen">
          <h3>Resumen del pedido</h3>
          <p id="emptyMsg" class="resumen-empty">A√∫n no agregaste productos.</p>
          <ul id="lista" class="resumen-list"></ul>

          <div class="totales" aria-live="polite">
            <div class="tot-line"><span>Subtotal</span><span id="subtotal">$ 0</span></div>
            <div id="envioLine" class="tot-line" hidden><span>Env√≠o</span><span id="envioCosto"></span></div>
            <div class="tot-line total"><span>Total</span><span id="total">$ 0</span></div>
          </div>

          <div class="acciones">
            <button id="btn-whatsapp" onclick="enviarPedido()">Hacer pedido por WhatsApp</button>
            <button id="btn-vaciar"   type="button" onclick="vaciarCarrito()">Vaciar carrito</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal vaciar -->
  <div id="dlgClearBackdrop" class="dialog-backdrop" aria-hidden="true">
    <div role="dialog" aria-modal="true" class="dialog">
      <h3>¬øVaciar el carrito?</h3>
      <p>Se eliminar√°n todos los productos.</p>
      <div class="dialog-actions">
        <button id="dlgClearYes" class="btn btn-primary">S√≠, vaciar</button>
        <button id="dlgClearNo"  class="btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- ============   SCRIPTS   ============ -->
  <script>
  /* ======= Variables editables por CMS (defaults) ======= */
  // D√≠as: 0=Dom, 1=Lun, 2=Mar, 3=Mi√©, 4=Jue, 5=Vie, 6=S√°b
  let HORARIOS = {
    rotiseria: { dias:[4,5,6,0], rangos:[{desde:'19:30', hasta:'22:30'}] },
    almacen:   { dias:[0,1,2,3,4,5,6], rangos:[{desde:'09:00', hasta:'23:59'}] }
  };
  let SECCIONES_CERRADAS = { rotiseria:false, almacen:false };
  let SHIPPING = 1000;                 // costo de env√≠o editable
  let WSP_NUMBER = '3415923882';       // WhatsApp editable

  /* ======= Analytics & helpers ======= */
  const ANALYTICS_KEY='tachi_events_v1';
  function getEvents(){try{return JSON.parse(localStorage.getItem(ANALYTICS_KEY)||'[]')}catch{return[]}}
  function saveEvents(l){localStorage.setItem(ANALYTICS_KEY,JSON.stringify(l))}
  function logEvent(t,d={}){const e={type:t,ts:new Date().toISOString(),path:location.pathname+location.search,...d};const l=getEvents();l.push(e);saveEvents(l)}

  /* ======= CSV utilidades ======= */
  const SEP=Intl.NumberFormat().format(1.1).includes(',')?';':',';
  const csvEscape=v=>v==null?'':(/[\"\\n\\r]/.test(v)||String(v).includes(SEP))?`\"${String(v).replace(/\"/g,'\"\"')}\"`:v;
  function downloadCSV(name,headers,rows){
    const lines=[headers.join(SEP),...rows.map(r=>headers.map(h=>csvEscape(r[h])).join(SEP))];
    const blob=new Blob(['\uFEFF'+lines.join('\r\n')],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);const a=document.createElement('a');
    a.href=url;a.download=name;document.body.appendChild(a);a.click();URL.revokeObjectURL(url);a.remove();
  }

  /* exportadores barra admin */
  function exportWspOrdersCSV(){
    const ev=getEvents().filter(e=>e.type==='order_wsp');
    if(!ev.length){alert('No hay pedidos por WhatsApp a√∫n');return}
    const rows=[];
    ev.forEach(o=>{
      (o.items||[]).forEach(it=>{
        rows.push({ts:o.ts,order_id:o.order_id,shipping:o.shipping,
          producto:it.name,cantidad:it.qty,precio_unit:it.unit_price,
          linea_total:it.line_total,subtotal:o.subtotal,
          envio:o.shipping_cost,total:o.total});
      });
    });
    downloadCSV(`pedidos-wsp-${new Date().toISOString().slice(0,10)}.csv`,
      ['ts','order_id','shipping','producto','cantidad','precio_unit','linea_total','subtotal','envio','total'],
      rows);
  }
  function exportTopProductsCSV(){
    const ev=getEvents().filter(e=>e.type==='order_wsp');
    if(!ev.length){alert('No hay pedidos por WhatsApp a√∫n');return}
    const map=new Map();
    ev.forEach(o=>{
      (o.items||[]).forEach(it=>{
        if(!map.has(it.name))map.set(it.name,{unidades:0,ingreso:0,pedidos:new Set()});
        const m=map.get(it.name);m.unidades+=it.qty;m.ingreso+=it.line_total;m.pedidos.add(o.order_id);
      });
    });
    const rows=[...map.entries()].map(([p,m])=>({producto:p,unidades:m.unidades,ingreso:m.ingreso,pedidos:m.pedidos.size}))
                .sort((a,b)=>b.unidades-a.unidades||b.ingreso-a.ingreso);
    downloadCSV(`top-productos-wsp-${new Date().toISOString().slice(0,10)}.csv`,
      ['producto','unidades','ingreso','pedidos'],rows);
  }
  function clearMetrics(){
    if(!getEvents().length){alert('No hay m√©tricas guardadas.');return}
    if(!confirm('¬øBorrar todas las m√©tricas locales? Esta acci√≥n no se puede deshacer.'))return;
    localStorage.removeItem(ANALYTICS_KEY);alert('Listo: m√©tricas borradas.');
  }

  /* ======= Persistencia & helpers ======= */
  const CART_KEY='tachi_cart_v1',CLIENT_KEY='tachi_client_v1';
  const formatARS=n=>new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n);
  const loadCart =()=>{try{return JSON.parse(localStorage.getItem(CART_KEY)||'{}')}catch{return{}}};
  const saveCart =obj=>localStorage.setItem(CART_KEY,JSON.stringify(obj));
  const loadClient=()=>{try{return JSON.parse(localStorage.getItem(CLIENT_KEY)||'{}')}catch{return{}}};
  const saveClient=obj=>localStorage.setItem(CLIENT_KEY,JSON.stringify(obj));
  const asset=p=>location.hostname.endsWith('github.io')?`/${location.pathname.split('/').filter(Boolean)[0]}/${p}`:`/${p}`;
  const normalizar=d=>Array.isArray(d?.categorias)?Object.fromEntries(d.categorias.map(c=>[c.categoria,c.productos||[]])):d||{};

  /* ======= Toast ======= */
  function showToast(msg,type='ok',t=2400){
    const wrap=document.getElementById('toastWrap');
    const el=document.createElement('div');
    el.className=`toast ${type==='error'?'err':type==='warn'?'warn':'ok'}`;
    el.textContent=msg;
    wrap.appendChild(el);
    setTimeout(()=>{el.style.opacity='0';el.style.transition='opacity .2s'},t);
    setTimeout(()=>wrap.removeChild(el),t+220);
  }

  /* ======= Helpers horarios ======= */
  function hmToMin(hm){const [h,m]=hm.split(':').map(Number);return h*60+(m||0)}
  function ahoraMin(){const n=new Date();return n.getHours()*60+n.getMinutes()}
  function hoyDia(){return new Date().getDay()}
  function estaAbierto(seccion){
    if(SECCIONES_CERRADAS[seccion]) return false;
    const cfg = HORARIOS[seccion]; if(!cfg) return true;
    if(!cfg.dias.includes(hoyDia())) return false;
    const now = ahoraMin();
    return cfg.rangos.some(r => now >= hmToMin(r.desde) && now <= hmToMin(r.hasta));
  }
  function proximoHorario(seccion){
    const cfg = HORARIOS[seccion]; if(!cfg) return null;
    const diasTxt=['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
    const d = hoyDia(), now=ahoraMin();

    if(cfg.dias.includes(d)){
      for(const r of cfg.rangos){
        if(now <= hmToMin(r.hasta)){
          return now <= hmToMin(r.desde) ? `Hoy ${r.desde}‚Äì${r.hasta}` : `Hoy hasta ${r.hasta}`;
        }
      }
    }
    for(let i=1;i<=7;i++){
      const nd=(d+i)%7;
      if(cfg.dias.includes(nd)){
        const r=cfg.rangos[0];
        return `${diasTxt[nd]} ${r.desde}‚Äì${r.hasta}`;
      }
    }
    return null;
  }
  function seccionDeId(id){
    if(id.startsWith('menu-rotiseria-')) return 'rotiseria';
    if(id.startsWith('menu-almacen-'))   return 'almacen';
    return id.includes('almacen') ? 'almacen' : 'rotiseria';
  }
  function seccionCerradaAhora(sec){ return !estaAbierto(sec); }

  function actualizarTabsPorHorario(){
    const tabs = [
      {sec:'rotiseria', btn:document.getElementById('btn-rotiseria')},
      {sec:'almacen',   btn:document.getElementById('btn-almacen')}
    ];
    tabs.forEach(({sec,btn})=>{
      if(!btn) return;
      if(seccionCerradaAhora(sec)){
        btn.classList.add('tab-closed');
        btn.setAttribute('aria-disabled','true');
      }else{
        btn.classList.remove('tab-closed');
        btn.removeAttribute('aria-disabled');
      }
    });
  }

  /* ======= AJUSTES desde CMS ======= */
  async function cargarAjustes(){
    try{
      const r = await fetch(asset('data/ajustes.json'));
      if(!r.ok) throw new Error('HTTP '+r.status);
      const aj = await r.json();

      // WhatsApp y env√≠o
      if(aj.whatsapp) WSP_NUMBER = String(aj.whatsapp).replace(/\D/g,'') || WSP_NUMBER;
      if(typeof aj.shipping === 'number') SHIPPING = aj.shipping;

      // Horarios y cierre forzado
      const h = aj.horarios || {};
      ['rotiseria','almacen'].forEach(sec=>{
        const cfg = h[sec] || {};
        if(!HORARIOS[sec]) HORARIOS[sec]={dias:[],rangos:[]};
        if(Array.isArray(cfg.dias)) HORARIOS[sec].dias = cfg.dias.map(Number);
        if(Array.isArray(cfg.rangos)) HORARIOS[sec].rangos = cfg.rangos.map(r=>({desde:r.desde, hasta:r.hasta}));
        if(typeof cfg.cerrado === 'boolean') SECCIONES_CERRADAS[sec] = cfg.cerrado;
      });

      actualizarTabsPorHorario();
    }catch(err){
      console.warn('No se pudo cargar data/ajustes.json; usando defaults.', err);
      showToast('Ajustes por defecto cargados','warn',1800);
    }
  }

  /* ======= Estado DOM ======= */
  const cantidades={}, listaEl=document.getElementById('lista'),
        subtotalEl=document.getElementById('subtotal'), totalEl=document.getElementById('total'),
        envioLineEl=document.getElementById('envioLine'), envioCostoEl=document.getElementById('envioCosto'),
        emptyMsg=document.getElementById('emptyMsg'), btnWA=document.getElementById('btn-whatsapp'),
        nombreEl=document.getElementById('nombre');

  const fab=document.getElementById('cartFab'), fabCount=document.getElementById('fabCount'), fabTotal=document.getElementById('fabTotal');
  const sheet=document.getElementById('cartSheet'), sheetClose=document.getElementById('sheetClose'), backdrop=document.getElementById('sheetBackdrop');
  let sheetOpen=false, METRICS_TOTAL=0,METRICS_COUNT=0,METRICS_ENVIO='';

  /* ======= Render productos (con soporte de Promos) ======= */
  function renderProductos(contId,data){
    const cont=document.getElementById(contId);cont.innerHTML='';
    const norm=normalizar(data);
    for(const cat in norm){
      const items=norm[cat]||[];const det=document.createElement('details');
      const sum=document.createElement('summary');sum.textContent=cat;det.appendChild(sum);
      items.forEach((prod,i)=>{
        const id=`${contId}-${cat}-${i}`;if(!(id in cantidades))cantidades[id]=0;
        const isPromo = !!prod._promo;
        const priceHTML = isPromo
          ? `<div class="price-wrap">
               ${prod._promo.precio_original ? `<span class="price-old">${formatARS(prod._promo.precio_original)}</span>` : ''}
               <span class="price-new">${formatARS(prod.precio)}</span>
             </div>`
          : `<h3>${prod.nombre} - ${formatARS(prod.precio)}</h3>`;

        const div=document.createElement('div');div.className='producto';
        div.innerHTML=`
          <div class="producto-info">
            <h3 style="margin:0;color:#004c99;font-size:1rem">
              ${prod.nombre}
              ${isPromo && prod._promo.tag ? `<span class="promo-badge">${prod._promo.tag}</span>` : ''}
            </h3>
            ${prod.desc?`<p>${prod.desc}</p>`:''}
            ${priceHTML}
          </div>
          <div class="contador">
            <button onclick="cambiarCantidad('${id}',-1,this)">‚àí</button>
            <span id="cantidad-${id}">0</span>
            <button onclick="cambiarCantidad('${id}',1,this)">+</button>
          </div>`;
        div.dataset.nombre=prod.nombre;div.dataset.precio=prod.precio;det.appendChild(div);
      });
      cont.appendChild(det);
    }
  }

  /* ======= Mezclar Promos arriba ======= */
  function mergePromos(baseData, promosData){
    const out = baseData && Array.isArray(baseData.categorias) ? { categorias:[...baseData.categorias] } : { categorias:[] };
    const promos = (promosData && Array.isArray(promosData.promos)) ? promosData.promos : [];
    const hoy = new Date().toISOString().slice(0,10);
    const vigentes = promos.filter(p => !p.vigencia_hasta || p.vigencia_hasta >= hoy);
    if(vigentes.length){
      out.categorias = [
        {
          categoria: '‚≠ê Promos',
          productos: vigentes.map(p => ({
            nombre: p.nombre,
            precio: p.precio,
            desc: p.desc || '',
            _promo: { precio_original: p.precio_original || null, tag: p.tag || null }
          }))
        },
        ...out.categorias
      ];
    }
    return out;
  }

  /* ======= Cargar JSON ======= */
  async function cargarProductos(){
    await cargarAjustes(); // ‚Üê primero leemos ajustes

    const rotiseria = fetch(asset('data/productos-rotiseria.json')).then(r=>r.json()).catch(()=>{ showToast('Error cargando Rotiser√≠a','error'); return {categorias:[]} });
    const almacen   = fetch(asset('data/productos-almacen.json')).then(r=>r.json()).catch(()=>{ showToast('Error cargando Almac√©n','error'); return {categorias:[]} });
    const promosR   = fetch(asset('data/promos-rotiseria.json')).then(r=>r.json()).catch(()=>({}));
    const promosA   = fetch(asset('data/promos-almacen.json')).then(r=>r.json()).catch(()=>({}));

    const [rOk,aOk,prOk,paOk] = await Promise.all([rotiseria, almacen, promosR, promosA]);
    const rMerge = mergePromos(rOk, prOk);
    const aMerge = mergePromos(aOk, paOk);

    renderProductos('menu-rotiseria', rMerge);
    renderProductos('menu-almacen',  aMerge);

    hydrateCart();hydrateClient();actualizarResumen();
    actualizarTabsPorHorario();
  }
  cargarProductos();

  /* ======= Hydration ======= */
  const hydrateCart=()=>Object.entries(loadCart()).forEach(([id,q])=>{if(q>0){cantidades[id]=q;const el=document.getElementById(`cantidad-${id}`);if(el)el.textContent=q}});
  function hydrateClient(){
    const c=loadClient();
    if(c.name)nombreEl.value=c.name;
    if(c.address)document.getElementById('direccion').value=c.address;
  }

  /* ======= Carrito ======= */
  function cambiarCantidad(id,delta,btn){
    // Bloqueo por horario/secci√≥n
    const sec = seccionDeId(id);
    if(delta > 0 && seccionCerradaAhora(sec)){
      const prox = proximoHorario(sec);
      showToast(`${sec[0].toUpperCase()+sec.slice(1)} est√° cerrada. ${prox?`Pr√≥ximo: ${prox}.`:''}`, 'warn');
      return;
    }

    cantidades[id]=Math.max(0,(cantidades[id]||0)+delta);
    const span=document.getElementById(`cantidad-${id}`);if(span)span.textContent=cantidades[id];
    if(delta>0&&btn){
      btn.classList.add('btn-pop');btn.addEventListener('animationend',()=>btn.classList.remove('btn-pop'),{once:true});
      const row=btn.closest('.producto');row.classList.add('row-flash');row.addEventListener('animationend',()=>row.classList.remove('row-flash'),{once:true});
      fab.classList.add('bump');fab.addEventListener('animationend',()=>fab.classList.remove('bump'),{once:true});
    }
    saveCart(cantidades);actualizarResumen();
  }
  const countItems=()=>Object.values(cantidades).reduce((a,b)=>a+(b||0),0);
  function setFabVisible(v){
    if(!fab)return;
    if(v){ fab.removeAttribute('hidden'); requestAnimationFrame(()=>fab.classList.remove('hide')); }
    else{ fab.classList.add('hide'); setTimeout(()=>fab.setAttribute('hidden',''),200); }
  }

  /* ======= Totales + validaci√≥n por horario ======= */
  function actualizarResumen(){
    listaEl.innerHTML='';let subtotal=0,count=0;

    const tiene = { rotiseria:0, almacen:0 };

    for(const id in cantidades){
      const qty=cantidades[id];if(qty<=0)continue;
      const span=document.getElementById(`cantidad-${id}`);if(!span)continue;
      const row=span.closest('.producto');const name=row?.dataset?.nombre;const price=parseInt(row?.dataset?.precio||0,10);
      const li=document.createElement('li');li.className='resumen-item';
      li.innerHTML=`<span class="resumen-name">${name||'-'}</span><span class="resumen-qty">x${qty}</span><span class="resumen-line">${formatARS(price*qty)}</span>`;
      listaEl.appendChild(li);subtotal+=price*qty;count+=qty;

      const sec = seccionDeId(id);
      tiene[sec]+=qty;
    }
    const envioInput=document.querySelector('input[name=envio]:checked');
    const envioSel=envioInput?envioInput.value:null;
    const envioCosto=envioSel==='envio'?SHIPPING:0;

    subtotalEl.textContent=formatARS(subtotal);
    if(envioCosto>0){ envioCostoEl.textContent=formatARS(envioCosto); envioLineEl.hidden=false; }
    else{ envioLineEl.hidden=true; envioCostoEl.textContent=''; }
    totalEl.textContent=formatARS(subtotal+envioCosto);

    emptyMsg.hidden=count>0; fabCount.textContent=count; fabTotal.textContent=formatARS(subtotal+envioCosto);
    setFabVisible(count>0&&!sheetOpen);

    // Validaci√≥n por horarios
    let puedePedir = true;
    let motivos = [];

    if(tiene.rotiseria>0 && seccionCerradaAhora('rotiseria')){
      puedePedir=false;
      const prox = proximoHorario('rotiseria'); motivos.push(`Rotiser√≠a cerrada. ${prox?`Pr√≥ximo: ${prox}.`:''}`);
    }
    if(tiene.almacen>0 && seccionCerradaAhora('almacen')){
      puedePedir=false;
      const prox = proximoHorario('almacen'); motivos.push(`Almac√©n cerrado. ${prox?`Pr√≥ximo: ${prox}.`:''}`);
    }

    const estado = document.getElementById('estadoHorarios') || (()=>{
      const p=document.createElement('p'); p.id='estadoHorarios'; p.style.margin='6px 0 0'; p.style.fontSize='.95rem'; p.style.color='#7a4c00';
      document.getElementById('resumen').insertBefore(p, document.getElementById('resumen').firstChild.nextSibling);
      return p;
    })();
    estado.textContent = puedePedir ? '' : motivos.join(' ');

    btnWA.disabled = !(count>0 && nombreEl.value.trim().length>0 && envioInput && puedePedir);

    METRICS_TOTAL=subtotal+envioCosto;METRICS_COUNT=count;METRICS_ENVIO=envioSel||'';
  }

  /* ======= Guardar inputs cliente ======= */
  nombreEl.addEventListener('input',()=>{saveClient({...loadClient(),name:nombreEl.value.trim()});actualizarResumen()});
  document.getElementById('direccion').addEventListener('input',e=>{saveClient({...loadClient(),address:e.target.value.trim()})});
  document.querySelectorAll('input[name=envio]').forEach(r=>r.addEventListener('change',actualizarResumen));

  /* ======= Vaciar carrito ======= */
  const dlgBackdrop=document.getElementById('dlgClearBackdrop'),
        dlgYes=document.getElementById('dlgClearYes'),
        dlgNo=document.getElementById('dlgClearNo');
  function abrirDialogoVaciar(){dlgBackdrop.classList.add('open');dlgYes.focus()}
  function cerrarDialogoVaciar(){dlgBackdrop.classList.remove('open')}
  dlgNo.addEventListener('click',cerrarDialogoVaciar);
  dlgBackdrop.addEventListener('click',e=>{if(e.target===dlgBackdrop)cerrarDialogoVaciar()});
  document.addEventListener('keydown',e=>{if(e.key==='Escape'&&dlgBackdrop.classList.contains('open'))cerrarDialogoVaciar()});
  dlgYes.addEventListener('click',()=>{
    Object.keys(cantidades).forEach(k=>cantidades[k]=0);
    document.querySelectorAll('[id^="cantidad-"]').forEach(el=>el.textContent='0');
    saveCart(cantidades);actualizarResumen();cerrarDialogoVaciar();showToast('Carrito vac√≠o','warn');
  });
  const vaciarCarrito=abrirDialogoVaciar;

  /* ======= Tabs (con cierre por horario) ======= */
  function mostrar(sec){
    const otra = sec==='almacen' ? 'rotiseria' : 'almacen';

    if(seccionCerradaAhora(sec)){
      const prox = proximoHorario(sec);
      showToast(`La secci√≥n ${sec} est√° cerrada. ${prox?`Pr√≥ximo: ${prox}.`:''}`,'warn');

      const cont = document.getElementById(`menu-${sec}`);
      cont.style.display = 'block';
      cont.innerHTML = `<div class="seccion-closed-overlay">üöß ${sec[0].toUpperCase()+sec.slice(1)} est√° cerrada por ahora. ${prox?`<br>Pr√≥ximo horario: <b>${prox}</b>.`:''}</div>`;

      document.getElementById(`menu-${otra}`).style.display='none';
      document.getElementById(`btn-${sec}`).classList.add('active');
      document.getElementById(`btn-${otra}`).classList.remove('active');
      return;
    }

    document.getElementById('menu-rotiseria').style.display = (sec==='rotiseria')?'block':'none';
    document.getElementById('menu-almacen').style.display    = (sec==='almacen')?'block':'none';
    document.getElementById('btn-rotiseria').classList.toggle('active', sec==='rotiseria');
    document.getElementById('btn-almacen').classList.toggle('active', sec==='almacen');
  }

  /* ======= WhatsApp ======= */
  function enviarPedido(){
    const name=nombreEl.value.trim(),addr=document.getElementById('direccion').value.trim();
    const envioInput=document.querySelector('input[name=envio]:checked');
    if(!envioInput){showToast('Seleccion√° si es env√≠o o retiro','error');return}
    const envio=envioInput.value;
    if(!name){showToast('Ingres√° tu nombre','error');return}
    if(countItems()===0){showToast('Seleccion√° al menos un producto','error');return}
    if(envio==='envio'&&!addr){showToast('Ingres√° tu direcci√≥n para el env√≠o','error');return}

    // Verificar secciones cerradas en el carrito
    const itemsPorSeccion = { rotiseria:0, almacen:0 };
    Object.entries(cantidades).forEach(([id,qty])=>{ if(qty>0) itemsPorSeccion[seccionDeId(id)] += qty; });
    if((itemsPorSeccion.rotiseria>0 && seccionCerradaAhora('rotiseria')) ||
       (itemsPorSeccion.almacen>0   && seccionCerradaAhora('almacen'))){
      actualizarResumen();
      showToast('No se puede enviar: hay productos de una secci√≥n cerrada.','error');
      return;
    }

    // Construir mensaje para WhatsApp
    let msg=`Hola, soy ${name}. Quiero hacer un pedido:\n`;
    const items=[];
    Object.entries(cantidades).forEach(([id,qty])=>{
      if(qty>0){
        const span=document.getElementById(`cantidad-${id}`); if(!span) return;
        const row=span.closest('.producto');
        const n=row.dataset.nombre, p=parseInt(row.dataset.precio,10), line=p*qty;
        msg+=`- ${n} x${qty} - ${formatARS(line)}\n`;
        items.push({ name:n, qty, unit_price:p, line_total:line });
      }
    });

    const subtotal = items.reduce((a,i)=>a+i.line_total,0);
    const shipping_cost = envio==='envio'?SHIPPING:0;
    const total = subtotal + shipping_cost;
    const order_id = 'W'+new Date().toISOString().replace(/[-:.TZ]/g,'').slice(0,14);

    msg+=envio==='envio'?`Env√≠o a domicilio a: ${addr} (+${formatARS(SHIPPING)})\n`:'Retiro en el local\n';
    msg+=`Total: ${formatARS(total)}`;

    logEvent('order_wsp',{ order_id, shipping:envio, shipping_cost, subtotal, total, items });

    window.open(`https://wa.me/${WSP_NUMBER}?text=${encodeURIComponent(msg)}`,'_blank');
    showToast('Abriendo WhatsApp...','ok');
  }

  /* ======= Sheet ======= */
  function trapFocus(e){
    if(!sheetOpen||e.key!=='Tab')return;
    const f=sheet.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
    if(!f.length)return;const first=f[0],last=f[f.length-1];
    if(e.shiftKey&&document.activeElement===first){e.preventDefault();last.focus()}
    else if(!e.shiftKey&&document.activeElement===last){e.preventDefault();first.focus()}
  }
  function openSheet(){
    if(sheetOpen)return;sheetOpen=true;document.body.style.overflow='hidden';
    sheet.classList.add('open');backdrop.classList.add('open');setFabVisible(false);
    setTimeout(()=>sheetClose.focus(),10);
    document.addEventListener('keydown',trapFocus);
  }
  function closeSheet(){
    if(!sheetOpen)return;sheetOpen=false;document.body.style.overflow='';
    sheet.classList.remove('open');backdrop.classList.remove('open');
    actualizarResumen();document.removeEventListener('keydown',trapFocus);
  }
  fab.addEventListener('click',e=>{e.preventDefault();openSheet()});
  sheetClose.addEventListener('click',closeSheet);backdrop.addEventListener('click',closeSheet);

  /* ======= Ocultar FAB al llegar a promo ======= */
  (function fabScrollHide(){
    const sentinel=document.querySelector('.promo-web');
    if(!sentinel)return;
    const io=new IntersectionObserver(entries=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          fab.classList.add('hide');
        }else{
          if(countItems()>0 && !sheetOpen){
            fab.removeAttribute('hidden');
            fab.classList.remove('hide');
          }
        }
      });
    },{threshold:0});
    io.observe(sentinel);
  })();

  /* ======= Promo mail link ======= */
  (function promoInit(){
    const subj=encodeURIComponent('Quiero una web para mi negocio');
    const body=encodeURIComponent(`Hola Ludmila,\nVi tu trabajo y quiero pedir un presupuesto para mi web.\n\nTipo de sitio: (cat√°logo / pedidos / restaurante / otro)\n¬øPanel para editar productos?: (s√≠/no)\n¬øPlazo ideal?: (fecha)\n\n¬°Gracias!`);
    const mailEl=document.getElementById('promoMail');
    if(mailEl)mailEl.href=`mailto:ludmilasolutions2.0@gmail.com?subject=${subj}&body=${body}`;
  })();

  /* ======= Barra admin (#admin) ======= */
  (function adminInit(){
    const bar=document.getElementById('adminBar');let bound=false;
    function bindOnce(){
      if(bound)return;bound=true;
      document.getElementById('exportOrdersBtn').onclick=exportWspOrdersCSV;
      document.getElementById('exportSummaryBtn').onclick=exportTopProductsCSV;
      document.getElementById('clearMetricsBtn').onclick=clearMetrics;
    }
    function isAdminHash(){return/\badmin\b/i.test(location.hash)}
    function setAdmin(on){document.body.classList.toggle('is-admin',!!on);if(on){bar.removeAttribute('hidden');bindOnce()}else{bar.setAttribute('hidden','')}}
    function update(){setAdmin(isAdminHash())}
    window.addEventListener('hashchange',update);
    window.addEventListener('pageshow',update);
    document.addEventListener('visibilitychange',()=>{if(!document.hidden)update()});
    update();
  })();

  // Refrescar tabs cada minuto por cambios de horario
  window.addEventListener('DOMContentLoaded', ()=>{
    actualizarTabsPorHorario();
    setInterval(actualizarTabsPorHorario, 60*1000);
  });
  </script>
</body>
</html>
