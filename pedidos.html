<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rotisería El Tachi</title>
  <link rel="icon" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>

  <!-- ============  ESTILOS  ============ -->
  <style>
    :root{
      --azul:#003366;
      --azul-2:#001122;
      --azul-3:#004080;
      --amarillo:#ffcc00;
      --gris-borde:#cbd5e1;
      --bg:#f8f9fa;
      --text:#333;
      --card:#fff;
      --card-hover:#f1f1f1;
      --resumen-bg:#fff3cd;
      --resumen-borde:#ffeeba;
      --ok:#16a34a;
      --error:#dc2626;
      --shadow:0 10px 24px rgba(0,0,0,.18);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Roboto',sans-serif;background:var(--bg);color:var(--text)}

    /* ---------- Header ---------- */
    header{
      background:linear-gradient(90deg,var(--azul) 0%,var(--azul-2) 100%);
      color:#fff;text-align:center;padding:2rem 1rem
    }
    header img{max-height:180px;margin:0 auto 1rem}

    main{padding:1rem 1rem 112px;max-width:900px;margin:auto}

    /* ---------- Tabs ---------- */
    .tabs{display:flex;justify-content:center;gap:1rem;flex-wrap:wrap;margin-bottom:1rem}
    .tabs button{
      padding:.8rem 1.8rem;font-size:1.1rem;border:none;border-radius:30px;
      background:var(--azul-3);color:var(--amarillo);font-weight:bold;
      box-shadow:0 3px 8px rgba(0,0,0,.2);cursor:pointer;transition:.3s;border:2px solid transparent
    }
    .tabs button:hover{background:#0055aa}
    .tabs button.active{background:var(--azul-2);border-color:var(--amarillo);box-shadow:0 4px 12px rgba(0,0,0,.3)}

    /* --- Estado sección cerrada --- */
    .tab-closed{opacity:.55; cursor:not-allowed; filter:grayscale(60%)}
    .tab-closed::after{content:' (CERRADO)'; font-weight:800}
    .seccion-closed-overlay{
      padding:1rem; border:1px dashed #f59e0b; border-radius:10px;
      margin:.5rem 0 1rem; background:#fff8e1; color:#7a4c00;
      font-size:1.05rem; text-align:center; font-weight:600;
    }

    /* ---------- Listados ---------- */
    details{border:1px solid var(--gris-borde);border-radius:8px;margin-bottom:1rem;overflow:hidden;background:var(--card)}
    summary{background:var(--azul);color:var(--amarillo);padding:1rem;cursor:pointer;font-weight:bold;font-size:1.1rem;user-select:none;list-style:none}

    .producto{
      display:grid; grid-template-columns:64px 1fr auto; align-items:center; gap:.9rem;
      padding:.7rem 1rem; border-top:1px solid #ddd; background:var(--card);transition:background .2s
    }
    .producto:hover{background:var(--card-hover)}
    .prod-thumb{
      width:64px; height:64px; border-radius:10px; overflow:hidden; background:#eef2f7;
      display:grid; place-items:center; border:1px solid #e5e7eb;
    }
    .prod-thumb img{width:100%; height:100%; object-fit:cover}
    .producto-info{display:flex; flex-direction:column; gap:.25rem}
    .producto h3{margin:.2rem 0;color:#004c99;font-size:1rem}
    .producto p{margin:.1rem 0;font-size:.9rem;color:var(--text)}
    .contador{display:flex;align-items:center;gap:.5rem}
    .contador button{
      background:var(--azul);color:var(--amarillo);border:none;padding:.3rem .6rem;
      font-weight:bold;font-size:1.2rem;cursor:pointer;border-radius:5px;transform-origin:center
    }
    @keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
    .btn-pop{animation:pop .22s ease-out}
    @keyframes flash{0%,100%{box-shadow:0 0 0 rgba(255,204,0,0)}50%{box-shadow:0 0 0 4px rgba(255,204,0,.35)}}
    .row-flash{animation:flash .35s ease-out}

    /* ---------- Precios de promos ---------- */
    .promo-badge{
      background:#ffef99;color:#7a4c00;border:1px solid #ffd84d;
      padding:.15rem .45rem;border-radius:999px;font-size:.8rem;font-weight:800;margin-left:.4rem
    }
    .price-wrap{display:flex;align-items:center;gap:.45rem;margin-top:auto}
    .price-old{text-decoration:line-through;opacity:.6;font-weight:700}
    .price-new{font-weight:900;color:#0b376d}

    /* ---------- Resumen ---------- */
    #resumen{background:var(--resumen-bg);border:1px solid var(--resumen-borde);border-radius:8px;padding:1rem}
    #resumen h3{margin-top:0}
    .resumen-empty{margin:.25rem 0 .5rem;opacity:.8}
    .resumen-list{list-style:none;padding:0;margin:.5rem 0 .75rem;display:grid;gap:.35rem}
    .resumen-item{
      display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:.6rem;
      background:#fff;border:1px solid var(--gris-borde);border-radius:8px;padding:.5rem .6rem
    }
    .resumen-name{font-weight:700;color:#0b376d}
    .resumen-qty{opacity:.85;min-width:42px;text-align:right}
    .resumen-line{font-weight:700;min-width:88px;text-align:right}

    /* ---------- Seguimiento (debajo del listado) ---------- */
    .track-card{
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
      background:#fff; border:1px dashed var(--gris-borde); border-radius:12px;
      padding:.8rem .9rem; margin:.35rem 0 1rem;
    }
    .track-left{display:flex; align-items:center; gap:.7rem}
    .track-emoji{font-size:1.25rem}
    .track-title{font-weight:800; color:#0b376d}
    .track-id{font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-weight:800; letter-spacing:.2px}
    .track-actions{display:flex; gap:.5rem; flex-wrap:wrap}
    .btn-mini{
      display:inline-flex; align-items:center; gap:.4rem;
      background:#fff; color:#0b376d; border:1px solid var(--gris-borde);
      border-radius:8px; padding:.45rem .7rem; font-weight:800; text-decoration:none; cursor:pointer;
    }
    .status-pill{
      padding:.2rem .55rem; border-radius:999px; font-weight:800; font-size:.85rem; border:1px solid transparent;
    }
    .s-nuevo{ background:#eef2ff; color:#1e3a8a; border-color:#c7d2fe}
    .s-prep{  background:#fff7ed; color:#9a3412; border-color:#fed7aa}
    .s-listo{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0; box-shadow:0 0 0 0 rgba(16,185,129,.7); animation:readyPulse 1.2s ease-out infinite}
    @keyframes readyPulse{ 0%{box-shadow:0 0 0 0 rgba(16,185,129,.6)} 70%{box-shadow:0 0 0 12px rgba(16,185,129,0)} 100%{box-shadow:0 0 0 0 rgba(16,185,129,0)} }

    .totales{display:grid;gap:.25rem;margin-top:.5rem}
    .tot-line{display:flex;justify-content:space-between;align-items:center;padding:.35rem .2rem}
    .tot-line.total{font-size:1.1rem;font-weight:800;border-top:1px dashed #d6d6d6;margin-top:.25rem;padding-top:.5rem}
    #resumen .acciones{display:flex;gap:.75rem;flex-wrap:wrap}
    #resumen button{
      background:var(--azul);color:var(--amarillo);border:none;border-radius:5px;
      padding:.8rem 1.2rem;font-weight:bold;font-size:1rem;cursor:pointer
    }
    #btn-vaciar{background:#fff;color:#333;border:1px solid var(--gris-borde)}
    #btn-whatsapp:disabled{opacity:.6;cursor:not-allowed}

    /* ---------- Inputs ---------- */
    label{display:block;margin-top:1rem;font-weight:700}
    label input[type="text"],input[type="email"],input[type="tel"]{
      width:100%;padding:.95rem 1rem;font-size:1.05rem;border:1px solid #d9dee7;
      border-radius:12px;outline:none;background:#fff;transition:box-shadow .15s,border-color .15s
    }
    label input[type="text"]:focus{border-color:#7aa2ff;box-shadow:0 0 0 3px rgba(122,162,255,.25)}
    @media(max-width:520px){
      label{font-size:1.05rem}
      label input{padding:1.05rem 1rem;font-size:1.125rem;border-radius:14px}
      label input::placeholder{font-size:1.05rem}
    }

    /* ---------- FAB ---------- */
    .cart-fab{
      position:fixed;right:16px;bottom:calc(18px + env(safe-area-inset-bottom));z-index:99;
      background:var(--azul);color:var(--amarillo);border:2px solid var(--amarillo);
      display:flex;align-items:center;gap:.6rem;padding:.7rem 1.1rem;border-radius:9999px;
      font-size:1.05rem;box-shadow:0 8px 20px rgba(0,0,0,.25);cursor:pointer;
      user-select:none;touch-action:manipulation;-webkit-tap-highlight-color:transparent;
      transition:transform .15s,opacity .18s,filter .18s
    }
    .cart-fab *{pointer-events:none}
    .cart-fab:hover{transform:translateY(-2px)}
    .cart-fab.hide{opacity:0;transform:translateY(8px);filter:blur(2px);pointer-events:none}
    .cart-fab[hidden]{display:none}
    .cart-total{font-weight:700;font-size:1rem}
    .cart-count{
      background:var(--amarillo);color:var(--azul-2);min-width:26px;height:26px;border-radius:999px;
      display:grid;place-items:center;font-weight:800;font-size:.9rem
    }

    /* ---------- Toasts ---------- */
    .toast-wrap{
      position:fixed;left:50%;bottom:84px;transform:translateX(-50%);z-index:200;
      display:flex;flex-direction:column;gap:.5rem;pointer-events:none
    }
    .toast{
      pointer-events:auto;background:#0b1f3a;color:#fff;border-left:4px solid var(--azul-3);
      padding:.7rem 1rem;border-radius:8px;box-shadow:0 10px 24px rgba(0,0,0,.25);
      animation:fadeIn .18s ease-out;max-width:calc(100vw - 40px)
    }
    .toast.ok{border-left-color:var(--ok)}
    .toast.err{border-left-color:var(--error)}
    .toast.warn{border-left-color:#ffb400}
    @keyframes fadeIn{from{opacity:0;transform:translate(-50%,10px)}to{opacity:1;transform:translate(-50%,0)}}

    /* ---------- Divider ---------- */
    .section-divider{
      margin:2rem auto 0;max-width:900px;padding:0 1rem;height:12px;border-radius:999px;
      background:linear-gradient(to right,rgba(0,0,0,0)0%,#cbd5e1 18%,#94a3b8 50%,#cbd5e1 82%,rgba(0,0,0,0)100%);
      box-shadow:inset 0 2px 6px rgba(0,0,0,.08),0 8px 18px rgba(0,0,0,.06)
    }

    /* ---------- Promo footer ---------- */
    .promo-web{margin:1.2rem auto 0;max-width:900px;padding:1.2rem}
    .promo-card{
      background:linear-gradient(135deg,var(--azul)0%,#062247 100%);color:#fff;border-radius:16px;
      padding:1.2rem;box-shadow:0 18px 36px rgba(0,0,0,.25);display:grid;gap:1rem
    }
    .promo-card h3{margin:.2rem 0 .2rem;font-size:1.4rem}
    .promo-sub{margin:0;opacity:.9}
    .promo-badges{display:flex;flex-wrap:wrap;gap:.5rem}
    .badge{
      background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);
      color:#fff;padding:.35rem .6rem;border-radius:999px;font-size:.9rem;display:flex;align-items:center;gap:.35rem
    }
    .promo-actions{display:flex;flex-wrap:wrap;gap:.6rem}
    .btn{
      display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 1rem;border-radius:10px;
      font-weight:700;text-decoration:none;cursor:pointer;transition:transform .12s ease,opacity .12s ease;
      border:2px solid transparent
    }
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--amarillo);color:#001122;border-color:var(--amarillo)}
    .promo-note{font-size:.9rem;opacity:.9}

    /* ---------- Sheet ---------- */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.32);opacity:0;pointer-events:none;transition:opacity .22s ease;z-index:98}
    .sheet-backdrop.open{opacity:1;pointer-events:auto}
    .sheet{
      position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);
      background:var(--card);border-top-left-radius:16px;border-top-right-radius:16px;
      box-shadow:var(--shadow);transition:transform .28s ease-out;max-height:92vh;
      display:grid;grid-template-rows:auto 1fr;z-index:99
    }
    .sheet.open{transform:translateY(0)}
    .sheet-header{
      position:sticky; top:0; background:var(--card);
      border-bottom:1px solid #e8e8e8;
      border-top-left-radius:16px;border-top-right-radius:16px;
      z-index:5;
      padding:.6rem .8rem .4rem;
      padding-right:56px;
    }
    .sheet-handle{width:36px;height:4px;border-radius:999px;background:#d7d7d7;margin:.2rem auto;position:absolute;left:50%;transform:translateX(-50%);top:6px}
    .sheet-title{margin:0 0 .35rem;font-size:1.05rem;font-weight:800;color:#0b376d}
    .sheet-close{
      position:absolute; right:8px; top:6px;
      width:44px; height:44px; display:grid; place-items:center;
      background:#ffffffcc; backdrop-filter:saturate(1.2) blur(2px);
      border:1px solid #d7d7d7; border-radius:12px;
      font-size:28px; line-height:1; color:var(--azul);
      cursor:pointer; z-index:6; -webkit-tap-highlight-color:transparent;
    }
    .sheet-close:active{transform:scale(.98)}
    .sheet-body{overflow:auto;padding:.8rem .9rem 1rem}
    @media(min-width:800px){
      .sheet{left:50%;right:auto;transform:translate(-50%,100%);width:720px;border-radius:16px}
      .sheet.open{transform:translate(-50%,0)}
    }

    /* ---------- Modal ---------- */
    .dialog-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;place-items:center;z-index:101}
    .dialog-backdrop.open{display:grid}
    .dialog{
      background:#fff;border-radius:14px;width:90%;max-width:340px;
      box-shadow:0 16px 32px rgba(0,0,0,.28);padding:1.4rem 1.2rem;text-align:center;
      animation:popin .24s ease-out
    }
    @keyframes popin{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .dialog h3{margin:.2rem 0 1rem;font-size:1.25rem;color:#0b376d}
    .dialog p{margin:0 0 1.2rem}
    .dialog-actions{display:flex;gap:.8rem;justify-content:center;flex-wrap:wrap}
    .dialog-actions .btn{flex:1 1 120px}

    /* ——— PASOS EN SHEET ——— */
    .steps {display:flex; gap:.5rem; align-items:center; font-weight:800; font-size:.9rem; color:#64748b; white-space:nowrap;}
    .step {display:flex; align-items:center; gap:.4rem}
    .step .dot {width:10px; height:10px; border-radius:999px; background:#cbd5e1}
    .step.active {color:#0b376d}
    .step.active .dot {background:var(--amarillo)}

    /* ——— SEGMENTED CONTROL ENVÍO/RETIRO ——— */
    .segmented {display:flex; gap:.5rem; margin:.6rem 0}
    .segmented input{display:none}
    .segmented label{
      flex:1; text-align:center; padding:.7rem 1rem; border:1px solid #cfd3dc;
      border-radius:12px; cursor:pointer; font-weight:800; background:#fff; transition:.15s;
    }
    .segmented input:checked + label{
      background:var(--azul); color:var(--amarillo); border-color:var(--azul);
      box-shadow:0 6px 16px rgba(0,0,0,.12);
    }
  </style>
</head>
<body>
  <!-- ============  ESTRUCTURA HTML  ============ -->
  <header>
    <img src="logo.png" alt="Rotisería El Tachi">
    <h1>Rotisería El Tachi</h1>
    <p>¡Hacé tu pedido desde la web!</p>
  </header>

  <main>
    <div class="tabs">
      <button id="btn-rotiseria" class="active" onclick="mostrar('rotiseria')">🍕 Rotisería</button>
      <button id="btn-bebidas"  onclick="mostrar('bebidas')">🥤 Bebidas</button>
    </div>

    <div id="menu-rotiseria"></div>
    <div id="menu-bebidas" style="display:none"></div>
  </main>

  <!-- FAB -->
  <button id="cartFab" type="button" class="cart-fab" hidden title="Ver pedido" aria-label="Ver pedido">
    <span class="cart-icon">🛒</span>
    <span class="cart-total" id="fabTotal">$ 0</span>
    <span class="cart-count" id="fabCount">0</span>
  </button>

  <!-- Divider -->
  <div class="section-divider" aria-hidden="true"></div>

  <!-- Promo footer -->
  <section id="promoWeb" class="promo-web" aria-labelledby="promo-web-title">
    <div class="promo-card">
      <div>
        <h3 id="promo-web-title">¿Querés una web como esta para tu negocio?</h3>
        <p class="promo-sub">Sitios rápidos, listos para vender y fáciles de editar.</p>
      </div>

      <div class="promo-badges">
        <span class="badge">⚡ Entrega rápida</span>
        <span class="badge">📱 100% responsive</span>
        <span class="badge">🛒 Panel para productos</span>
        <span class="badge">🔒 Hosting & dominio opcional</span>
        <span class="badge">💬 Soporte por email</span>
      </div>

      <div class="promo-actions">
        <a id="promoMail" class="btn btn-primary" href="#">✉️ Pedí tu presupuesto</a>
      </div>

      <p class="promo-note">Creado por <strong>Ludmila Mercado</strong></p>
    </div>
  </section>

  <!-- Toasts -->
  <div id="toastWrap" class="toast-wrap"></div>

  <!-- Bottom-sheet del carrito -->
  <div id="sheetBackdrop" class="sheet-backdrop" aria-hidden="true"></div>
  <div id="cartSheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" aria-hidden="true">
    <div class="sheet-header">
      <span class="sheet-handle" aria-hidden="true"></span>
      <h3 id="sheetTitle" class="sheet-title">Tu pedido</h3>

      <div class="steps" id="checkoutSteps" aria-label="Progreso">
        <div class="step" data-step="1"><span class="dot"></span><span>Datos</span></div>
        <span>→</span>
        <div class="step" data-step="2"><span class="dot"></span><span>Resumen</span></div>
        <span>→</span>
        <div class="step" data-step="3"><span class="dot"></span><span>WhatsApp</span></div>
      </div>

      <button id="sheetClose" type="button" class="sheet-close" aria-label="Cerrar">✕</button>
    </div>

    <div id="sheetBody" class="sheet-body" tabindex="0">
      <section id="checkout">
        <!-- Retiro / Envío (SIN cambios de UX) -->
        <div class="segmented" role="tablist" aria-label="Entrega">
          <input id="opt-ret" type="radio" name="envio" value="retiro">
          <label for="opt-ret">Retiro</label>
          <input id="opt-env" type="radio" name="envio" value="envio">
          <label for="opt-env">Envío (+$1000)</label>
        </div>

        <label>Nombre:
          <input type="text" id="nombre" placeholder="Tu nombre">
        </label>

        <label>Dirección:
          <input type="text" id="direccion" placeholder="Calle, número, piso/depto">
        </label>

        <div id="resumen">
          <h3>Resumen del pedido</h3>
          <p id="emptyMsg" class="resumen-empty">Aún no agregaste productos.</p>
          <ul id="lista" class="resumen-list"></ul>

          <!-- 🔎 Seguimiento (debajo del listado) -->
          <div id="trackBox" class="track-card" hidden>
            <div class="track-left">
              <div class="track-emoji">📦</div>
              <div>
                <div class="track-title">Seguimiento de tu pedido</div>
                <div style="font-size:.92rem;opacity:.9">ID: <span id="trackId" class="track-id"></span></div>
              </div>
            </div>
            <div class="track-actions">
              <span id="trackEstado" class="status-pill s-nuevo">Nuevo</span>
              <button id="trackRefresh" type="button" class="btn-mini">Refrescar</button>
              <a id="trackOpen" class="btn-mini" target="_blank" rel="noopener">Ver estado</a>
            </div>
          </div>

          <div class="totales" aria-live="polite">
            <div class="tot-line"><span>Subtotal</span><span id="subtotal">$ 0</span></div>
            <div id="envioLine" class="tot-line" hidden><span>Envío</span><span id="envioCosto"></span></div>
            <div class="tot-line total"><span>Total</span><span id="total">$ 0</span></div>
          </div>

          <div class="acciones">
            <button id="btn-whatsapp" onclick="enviarPedido()">Hacer pedido por WhatsApp</button>
            <button id="btn-vaciar"   type="button" onclick="vaciarCarrito()">Vaciar carrito</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal vaciar -->
  <div id="dlgClearBackdrop" class="dialog-backdrop" aria-hidden="true">
    <div role="dialog" aria-modal="true" class="dialog">
      <h3>¿Vaciar el carrito?</h3>
      <p>Se eliminarán todos los productos.</p>
      <div class="dialog-actions">
        <button id="dlgClearYes" class="btn btn-primary">Sí, vaciar</button>
        <button id="dlgClearNo"  class="btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- ============   SCRIPTS   ============ -->
  <script>
  /* ======= Variables editables por CMS (defaults) ======= */
  let HORARIOS = {
    rotiseria: { dias:[4,5,6,0], rangos:[{desde:'19:30', hasta:'22:30'}] },
    bebidas:   { dias:[0,1,2,3,4,5,6], rangos:[{desde:'09:00', hasta:'23:59'}] }
  };
  let SECCIONES_CERRADAS = { rotiseria:false, bebidas:false };
  let CIERRE_MSGS = { rotiseria:'', bebidas:'' };
  let SHIPPING = 1000;
  let WSP_NUMBER = '3415923882';

  /* ======= Analytics / Webhook Apps Script ======= */
  const ANALYTICS_KEY='tachi_events_v1';
  // ⬇️⬇️⬇️ REEMPLAZAR por la URL de tu Web App de Apps Script
  const ANALYTICS_WEBHOOK='https://script.google.com/macros/s/AKfycbz_pZVIydPyLn98VfzaeSzMRbrJ5BsyfTDlCTU_dBm8qy8gV2lYrobcKqJCU5OhPhyn/exec';
  // ⬆️⬆️⬆️
  const TRACK_PANEL_URL = ANALYTICS_WEBHOOK + '?view=panel';
  const TRACK_JSON_URL  = ANALYTICS_WEBHOOK + '?view=json';

  function getEvents(){try{return JSON.parse(localStorage.getItem(ANALYTICS_KEY)||'[]')}catch{return[]}}
  function saveEvents(l){localStorage.setItem(ANALYTICS_KEY,JSON.stringify(l))}
  function logEvent(type,data={}){const e={type,ts:new Date().toISOString(),path:location.pathname+location.search,...data};const l=getEvents();l.push(e);saveEvents(l); scheduleFlush();}

  let FLUSH_TIMER=null;
  function scheduleFlush(delay=1500){ clearTimeout(FLUSH_TIMER); FLUSH_TIMER=setTimeout(()=>flushEvents('timer'), delay); }

  function flushEvents(reason='auto'){
    const events=getEvents();
    if(!events.length) return;
    const payload={ kind:'batch', reason, url:location.href, ref:document.referrer||'', tz:Intl.DateTimeFormat().resolvedOptions().timeZone||'', ua:navigator.userAgent, events };
    let sent=false;
    try{
      if(navigator.sendBeacon){
        const blob=new Blob([JSON.stringify(payload)],{type:'text/plain'});
        sent=navigator.sendBeacon(ANALYTICS_WEBHOOK, blob);
      }
    }catch(e){}
    if(!sent){
      try{
        fetch(ANALYTICS_WEBHOOK,{method:'POST',mode:'no-cors',keepalive:true,body:JSON.stringify(payload)});
      }catch(e){}
    }
    saveEvents([]);
  }
  window.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='hidden'){ flushEvents('hidden'); }});
  window.addEventListener('beforeunload',()=>{ flushEvents('unload'); });
  window.addEventListener('online',()=>scheduleFlush(250));
  setInterval(()=>flushEvents('interval'), 20000);

  /* ======= Helpers + TTL (2 horas) ======= */
  const asset=p=>location.hostname.endsWith('github.io')?`/${location.pathname.split('/').filter(Boolean)[0]}/${p}`:`/${p}`;
  const normalizar=d=>Array.isArray(d?.categorias)?Object.fromEntries(d.categorias.map(c=>[c.categoria,c.productos||[]])):d||{};

  // Storage con vencimiento (TTL)
  function setWithTTL(key, value, ttlMs){const payload={ v:value, exp:Date.now()+ttlMs }; localStorage.setItem(key, JSON.stringify(payload));}
  function getWithTTL(key, fallback){
    try{
      const raw=JSON.parse(localStorage.getItem(key));
      if(!raw || typeof raw!=='object') return fallback;
      if(raw.exp && Date.now()>raw.exp){ localStorage.removeItem(key); return fallback; }
      return (raw.v===undefined?fallback:raw.v);
    }catch{ return fallback; }
  }
  function isExpired(key){ try{const raw=JSON.parse(localStorage.getItem(key)); return !!(raw && raw.exp && Date.now()>raw.exp);}catch{ return false; } }

  const CART_TTL_MS=2*60*60*1000; // 2h
  const CLIENT_TTL_MS=2*60*60*1000; // 2h
  const CART_KEY='tachi_cart_v1';
  const CLIENT_KEY='tachi_client_v1';
  const LAST_TRACK_KEY='tachi_last_track_v1'; // {order_id,name,first_item,created_at}
  const loadCart   = () => getWithTTL(CART_KEY, {});
  const saveCart   = (obj) => setWithTTL(CART_KEY, obj,   CART_TTL_MS);
  const loadClient = () => getWithTTL(CLIENT_KEY, {});
  const saveClient = (obj) => setWithTTL(CLIENT_KEY, obj, CLIENT_TTL_MS);

  /* ======= Toast ======= */
  function showToast(msg,type='ok',t=2400){
    const wrap=document.getElementById('toastWrap');
    const el=document.createElement('div');
    el.className=`toast ${type==='error'?'err':type==='warn'?'warn':'ok'}`;
    el.textContent=msg;
    wrap.appendChild(el);
    setTimeout(()=>{el.style.opacity='0';el.style.transition='opacity .2s'},t);
    setTimeout(()=>wrap.removeChild(el),t+220);
  }

  /* ======= Horarios ======= */
  function hmToMin(hm){const [h,m]=hm.split(':').map(Number);return h*60+(m||0)}
  function ahoraMin(){const n=new Date();return n.getHours()*60+n.getMinutes()}
  function hoyDia(){return new Date().getDay()}
  function estaAbierto(seccion){
    if(SECCIONES_CERRADAS[seccion]) return false;
    const cfg = HORARIOS[seccion]; if(!cfg) return true;
    if(!cfg.dias.includes(hoyDia())) return false;
    const now = ahoraMin();
    return cfg.rangos.some(r => now >= hmToMin(r.desde) && now <= hmToMin(r.hasta));
  }
  function proximoHorario(seccion){
    const cfg = HORARIOS[seccion]; if(!cfg) return null;
    const diasTxt=['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
    const d = hoyDia(), now=ahoraMin();
    if(cfg.dias.includes(d)){
      for(const r of cfg.rangos){
        if(now <= hmToMin(r.hasta)){
          return now <= hmToMin(r.desde) ? `Hoy ${r.desde}–${r.hasta}` : `Hoy hasta ${r.hasta}`;
        }
      }
    }
    for(let i=1;i<=7;i++){
      const nd=(d+i)%7;
      if(cfg.dias.includes(nd)){
        const r=cfg.rangos[0];
        return `${diasTxt[nd]} ${r.desde}–${r.hasta}`;
      }
    }
    return null;
  }
  function seccionDeId(id){
    if(id.startsWith('menu-rotiseria-')) return 'rotiseria';
    if(id.startsWith('menu-bebidas-'))   return 'bebidas';
    return id.includes('bebidas') ? 'bebidas' : 'rotiseria';
  }
  function seccionCerradaAhora(sec){ return !estaAbierto(sec); }
  function mensajeCierre(sec){
    if(SECCIONES_CERRADAS[sec] && CIERRE_MSGS[sec]?.trim()){
      return CIERRE_MSGS[sec].trim();
    }
    const prox = proximoHorario(sec);
    return prox ? `Próximo horario: ${prox}.` : 'Cerrado por ahora.';
  }
  function actualizarTabsPorHorario(){
    [{sec:'rotiseria',btn:document.getElementById('btn-rotiseria')},
     {sec:'bebidas',  btn:document.getElementById('btn-bebidas')}].forEach(({sec,btn})=>{
      if(!btn) return;
      if(seccionCerradaAhora(sec)){
        btn.classList.add('tab-closed'); btn.setAttribute('aria-disabled','true'); btn.title=mensajeCierre(sec);
      }else{
        btn.classList.remove('tab-closed'); btn.removeAttribute('aria-disabled'); btn.removeAttribute('title');
      }
    });
  }

  /* ======= AJUSTES / CARGA PRODUCTOS ======= */
  async function cargarAjustes(){
    try{
      const r = await fetch(asset('data/ajustes.json'));
      if(!r.ok) throw new Error('HTTP '+r.status);
      const aj = await r.json();
      if(aj.whatsapp) WSP_NUMBER = String(aj.whatsapp).replace(/\D/g,'') || WSP_NUMBER;
      if(typeof aj.shipping === 'number') SHIPPING = aj.shipping;
      const h = aj.horarios || {};
      ['rotiseria','bebidas'].forEach(sec=>{
        const cfg = h[sec] || {};
        if(!HORARIOS[sec]) HORARIOS[sec]={dias:[],rangos:[]};
        if(Array.isArray(cfg.dias)) HORARIOS[sec].dias = cfg.dias.map(Number);
        if(Array.isArray(cfg.rangos)) HORARIOS[sec].rangos = cfg.rangos.map(r=>({desde:r.desde, hasta:r.hasta}));
        if(typeof cfg.cerrado === 'boolean') SECCIONES_CERRADAS[sec] = cfg.cerrado;
        CIERRE_MSGS[sec] = (cfg.mensaje_cierre || '').toString();
      });
      actualizarTabsPorHorario();
    }catch(err){
      console.warn('No se pudo cargar data/ajustes.json; usando defaults.', err);
      showToast('Ajustes por defecto cargados','warn',1800);
    }
  }

  const cantidades = {}; // <— importante: declarar antes de usar

  function renderProductos(contId,data){
    const cont=document.getElementById(contId);cont.innerHTML='';
    const norm=normalizar(data);
    for(const cat in norm){
      const items=norm[cat]||[];const det=document.createElement('details');
      const sum=document.createElement('summary');sum.textContent=cat;det.appendChild(sum);
      items.forEach((prod,i)=>{
        const id=`${contId}-${cat}-${i}`;if(!(id in cantidades))cantidades[id]=0;
        const isPromo = !!prod._promo;
        const priceHTML = isPromo
          ? `<div class="price-wrap">
               ${prod._promo.precio_original ? `<span class="price-old">${formatARS(prod._promo.precio_original)}</span>` : ''}
               <span class="price-new">${formatARS(prod.precio)}</span>
             </div>`
          : `<div class="price-wrap"><span class="price-new">${formatARS(prod.precio)}</span></div>`;

        const div=document.createElement('div');div.className='producto';
        const thumb = prod.img ? asset(prod.img) : asset('logo.png');
        div.innerHTML=`
          <div class="prod-thumb"><img src="${thumb}" alt="${prod.nombre}"></div>
          <div class="producto-info">
            <h3 style="margin:0;color:#004c99;font-size:1rem">
              ${prod.nombre}
              ${isPromo && prod._promo.tag ? `<span class="promo-badge">${prod._promo.tag}</span>` : ''}
            </h3>
            ${prod.desc?`<p>${prod.desc}</p>`:''}
            ${priceHTML}
          </div>
          <div class="contador">
            <button onclick="cambiarCantidad('${id}',-1,this)">−</button>
            <span id="cantidad-${id}">0</span>
            <button onclick="cambiarCantidad('${id}',1,this)">+</button>
          </div>`;
        div.dataset.nombre=prod.nombre;
        div.dataset.precio=prod.precio;
        div.dataset.pid = prod.id ? String(prod.id) : id;  // ← product_id
        det.appendChild(div);
      });
      cont.appendChild(det);
    }
  }

  function mergePromos(baseData, promosData){
    const out = baseData && Array.isArray(baseData.categorias) ? { categorias:[...baseData.categorias] } : { categorias:[] };
    const promos = (promosData && Array.isArray(promosData.promos)) ? promosData.promos : [];
    const hoy = new Date().toISOString().slice(0,10);
    const vigentes = promos.filter(p => !p.vigencia_hasta || p.vigencia_hasta >= hoy);
    if(vigentes.length){
      out.categorias = [
        {
          categoria: '⭐ Promos',
          productos: vigentes.map(p => ({
            id: p.id || null,
            nombre: p.nombre,
            precio: p.precio,
            desc: p.desc || '',
            _promo: { precio_original: p.precio_original || null, tag: p.tag || null }
          }))
        },
        ...out.categorias
      ];
    }
    return out;
  }

  async function cargarProductos(){
    await cargarAjustes();

    if(isExpired(CART_KEY))   localStorage.removeItem(CART_KEY);
    if(isExpired(CLIENT_KEY)) localStorage.removeItem(CLIENT_KEY);

    const rotiseria = fetch(asset('data/productos-rotiseria.json')).then(r=>r.json()).catch(()=>({categorias:[]}));
    const bebidas   = fetch(asset('data/productos-bebidas.json')).then(r=>r.json()).catch(()=>({categorias:[]}));
    const promosR   = fetch(asset('data/promos-rotiseria.json')).then(r=>r.json()).catch(()=>({}));
    const promosB   = fetch(asset('data/promos-bebidas.json')).then(r=>r.json()).catch(()=>({}));

    const [rOk,bOk,prOk,pbOk] = await Promise.all([rotiseria, bebidas, promosR, promosB]);
    const rMerge = mergePromos(rOk, prOk);
    const bMerge = mergePromos(bOk, pbOk);

    renderProductos('menu-rotiseria', rMerge);
    renderProductos('menu-bebidas',  bMerge);

    hydrateCart();hydrateClient();actualizarResumen();
    actualizarTabsPorHorario();

    logEvent('menus_loaded',{rotiseria_cats:(rMerge.categorias||[]).length,bebidas_cats:(bMerge.categorias||[]).length});
  }
  cargarProductos();

  /* ======= Hydration ======= */
  const formatARS=n=>new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n);
  const hydrateCart=()=>Object.entries(loadCart()).forEach(([id,q])=>{if(q>0){cantidades[id]=q;const el=document.getElementById(`cantidad-${id}`);if(el)el.textContent=q}});
  function hydrateClient(){
    const c=loadClient();
    if(c.name)document.getElementById('nombre').value=c.name;
    if(c.address)document.getElementById('direccion').value=c.address;
  }

  /* ======= Carrito ======= */
  function cambiarCantidad(id,delta,btn){
    const sec = seccionDeId(id);
    if(delta > 0 && seccionCerradaAhora(sec)){
      showToast(`${sec[0].toUpperCase()+sec.slice(1)} está cerrada. ${mensajeCierre(sec)}`, 'warn');
      return;
    }
    cantidades[id]=Math.max(0,(cantidades[id]||0)+delta);
    const span=document.getElementById(`cantidad-${id}`);if(span)span.textContent=cantidades[id];
    if(delta>0&&btn){
      btn.classList.add('btn-pop');btn.addEventListener('animationend',()=>btn.classList.remove('btn-pop'),{once:true});
      const row=btn.closest('.producto');row.classList.add('row-flash');row.addEventListener('animationend',()=>row.classList.remove('row-flash'),{once:true});
      const fab=document.getElementById('cartFab');fab.classList.add('bump');fab.addEventListener('animationend',()=>fab.classList.remove('bump'),{once:true});
    }
    try{
      const row=document.getElementById(`cantidad-${id}`)?.closest('.producto');
      const name=row?.dataset?.nombre||''; const price=parseInt(row?.dataset?.precio||0,10);
      logEvent('qty_change',{id,delta,new_qty:cantidades[id],sec,name,price});
    }catch{}
    saveCart(cantidades);actualizarResumen();
  }
  const countItems=()=>Object.values(cantidades).reduce((a,b)=>a+(b||0),0);
  function setFabVisible(v){
    const fab=document.getElementById('cartFab'); if(!fab)return;
    if(v){ fab.removeAttribute('hidden'); requestAnimationFrame(()=>fab.classList.remove('hide')); }
    else{ fab.classList.add('hide'); setTimeout(()=>fab.setAttribute('hidden',''),200); }
  }

  /* ======= Totales + validación por horario ======= */
  function actualizarResumen(){
    const listaEl=document.getElementById('lista'),
          subtotalEl=document.getElementById('subtotal'),
          totalEl=document.getElementById('total'),
          envioLineEl=document.getElementById('envioLine'),
          envioCostoEl=document.getElementById('envioCosto'),
          emptyMsg=document.getElementById('emptyMsg'),
          btnWA=document.getElementById('btn-whatsapp'),
          nombreEl=document.getElementById('nombre');
    const fabCount=document.getElementById('fabCount'), fabTotal=document.getElementById('fabTotal');

    listaEl.innerHTML='';let subtotal=0,count=0;
    const tiene = { rotiseria:0, bebidas:0 };

    for(const id in cantidades){
      const qty=cantidades[id];if(qty<=0)continue;
      const span=document.getElementById(`cantidad-${id}`);if(!span)continue;
      const row=span.closest('.producto');const name=row?.dataset?.nombre;const price=parseInt(row?.dataset?.precio||0,10);
      const li=document.createElement('li');li.className='resumen-item';
      li.innerHTML=`<span class="resumen-name">${name||'-'}</span><span class="resumen-qty">x${qty}</span><span class="resumen-line">${formatARS(price*qty)}</span>`;
      listaEl.appendChild(li);subtotal+=price*qty;count+=qty;
      const sec = seccionDeId(id); tiene[sec]+=qty;
    }
    const envioInput=document.querySelector('input[name=envio]:checked');
    const envioSel=envioInput?envioInput.value:null;
    const envioCosto=envioSel==='envio'?SHIPPING:0;

    subtotalEl.textContent=formatARS(subtotal);
    if(envioCosto>0){ envioCostoEl.textContent=formatARS(envioCosto); envioLineEl.hidden=false; }
    else{ envioLineEl.hidden=true; envioCostoEl.textContent=''; }
    totalEl.textContent=formatARS(subtotal+envioCosto);

    emptyMsg.hidden=count>0; fabCount.textContent=count; fabTotal.textContent=formatARS(subtotal+envioCosto);
    setFabVisible(count>0&&!window.sheetOpen);

    // Validación por horarios
    let puedePedir = true; let motivos = [];
    if(tiene.rotiseria>0 && seccionCerradaAhora('rotiseria')){ puedePedir=false; motivos.push(`Rotisería cerrada. ${mensajeCierre('rotiseria')}`); }
    if(tiene.bebidas>0 && seccionCerradaAhora('bebidas')){  puedePedir=false; motivos.push(`Bebidas cerrada. ${mensajeCierre('bebidas')}`); }

    const estado = document.getElementById('estadoHorarios') || (()=>{
      const p=document.createElement('p'); p.id='estadoHorarios'; p.style.margin='6px 0 0'; p.style.fontSize='.95rem'; p.style.color='#7a4c00';
      document.getElementById('resumen').insertBefore(p, document.getElementById('resumen').firstChild.nextSibling);
      return p;
    })();
    estado.textContent = puedePedir ? '' : motivos.join(' ');

    btnWA.disabled = !(count>0 && nombreEl.value.trim().length>0 && puedePedir);

    window.METRICS_TOTAL=subtotal+envioCosto;window.METRICS_COUNT=count;window.METRICS_ENVIO=envioSel||'';

    actualizarPasos();
  }

  /* ======= Guardar inputs cliente + analíticas ======= */
  document.getElementById('nombre').addEventListener('input',()=>{
    const nombreEl=document.getElementById('nombre');
    saveClient({...loadClient(),name:nombreEl.value.trim()});
    logEvent('name_input',{len:nombreEl.value.trim().length});
    actualizarResumen(); actualizarPasos();
  });
  document.getElementById('direccion').addEventListener('input',e=>{
    saveClient({...loadClient(),address:e.target.value.trim()});
    logEvent('address_input',{len:e.target.value.trim().length});
    actualizarPasos();
  });
  document.querySelectorAll('input[name=envio]').forEach(r=>r.addEventListener('change',()=>{
    logEvent('envio_select',{value:document.querySelector('input[name=envio]:checked')?.value||''});
    actualizarResumen(); actualizarPasos();
  }));

  /* ======= Vaciar carrito ======= */
  const dlgBackdrop=document.getElementById('dlgClearBackdrop'),
        dlgYes=document.getElementById('dlgClearYes'),
        dlgNo=document.getElementById('dlgClearNo');
  function abrirDialogoVaciar(){dlgBackdrop.classList.add('open');dlgYes.focus()}
  function cerrarDialogoVaciar(){dlgBackdrop.classList.remove('open')}
  dlgNo.addEventListener('click',cerrarDialogoVaciar);
  dlgBackdrop.addEventListener('click',e=>{if(e.target===dlgBackdrop)cerrarDialogoVaciar()});
  document.addEventListener('keydown',e=>{if(e.key==='Escape'&&dlgBackdrop.classList.contains('open'))cerrarDialogoVaciar()});
  dlgYes.addEventListener('click',()=>{
    Object.keys(cantidades).forEach(k=>cantidades[k]=0);
    document.querySelectorAll('[id^="cantidad-"]').forEach(el=>el.textContent='0');
    saveCart(cantidades);actualizarResumen();cerrarDialogoVaciar();
    logEvent('cart_clear');
  });
  const vaciarCarrito=abrirDialogoVaciar;

  /* ======= Tabs ======= */
  function mostrar(sec){
    const otra = sec==='bebidas' ? 'rotiseria' : 'bebidas';
    logEvent('tab_show',{sec});
    if(seccionCerradaAhora(sec)){
      const cont = document.getElementById(`menu-${sec}`);
      cont.style.display = 'block';
      const nombreSec = sec[0].toUpperCase()+sec.slice(1);
      cont.innerHTML = `<div class="seccion-closed-overlay">🚧 ${nombreSec} está cerrada por ahora.<br>${mensajeCierre(sec)}</div>`;
      document.getElementById(`menu-${otra}`).style.display='none';
      document.getElementById(`btn-${sec}`).classList.add('active');
      document.getElementById(`btn-${otra}`).classList.remove('active');
      return;
    }
    document.getElementById('menu-rotiseria').style.display = (sec==='rotiseria')?'block':'none';
    document.getElementById('menu-bebidas').style.display    = (sec==='bebidas')?'block':'none';
    document.getElementById('btn-rotiseria').classList.toggle('active', sec==='rotiseria');
    document.getElementById('btn-bebidas').classList.toggle('active', sec==='bebidas');
  }

  /* ======= Seguimiento del pedido (cliente) ======= */
  let TRACK_TIMER=null;
  function saveLastTrack(obj){ localStorage.setItem(LAST_TRACK_KEY, JSON.stringify(obj)); }
  function getLastTrack(){ try{ return JSON.parse(localStorage.getItem(LAST_TRACK_KEY)||'null'); }catch{ return null; } }
  function clearLastTrack(){
    localStorage.removeItem(LAST_TRACK_KEY);
    const box=document.getElementById('trackBox');
    if(box){ box.hidden=true; }
  }

  function setEstadoPill(estado){
    const pill=document.getElementById('trackEstado');
    if(!pill) return;
    const e=(estado||'Nuevo').toString();
    pill.textContent=e;
    pill.classList.remove('s-nuevo','s-prep','s-listo');
    if(e==='Listo') pill.classList.add('s-listo');
    else if(e==='En preparación') pill.classList.add('s-prep');
    else pill.classList.add('s-nuevo');
  }

  function sameDayToday(tsStr){
    // intenta parsear dd/MM/yyyy ...
    try{
      const m=String(tsStr).match(/(\d{2})\/(\d{2})\/(\d{4})/);
      if(!m) return true; // si no hay ts, no filtramos
      const d=new Date(Number(m[3]), Number(m[2])-1, Number(m[1]));
      const t=new Date();
      return d.getFullYear()===t.getFullYear() && d.getMonth()===t.getMonth() && d.getDate()===t.getDate();
    }catch{ return true; }
  }

  async function fetchTrackAndRender(){
    const info=getLastTrack(); if(!info) return;
    try{
      const r = await fetch(TRACK_JSON_URL, {credentials:'omit'}); // si CORS bloquea, luego ajustamos en Apps Script
      if(!r.ok) throw new Error('HTTP '+r.status);
      const rows = await r.json();
      if(!Array.isArray(rows) || !rows.length) return;

      // Heurística: último pedido de HOY con ese nombre (y si podemos, que contenga el primer ítem)
      const candidates = rows.filter(p =>
        String(p.name||'').trim().toLowerCase() === String(info.name||'').trim().toLowerCase()
        && sameDayToday(p.ts_str||p.ts)
      );
      if(!candidates.length) return;

      // El más reciente (el JSON viene reverse() en el server, por si acaso ordenamos)
      candidates.sort((a,b)=> (String(b.ts_str||'')>String(a.ts_str||''))?1:-1);
      let found = candidates[0];

      if(info.first_item){
        const hit = candidates.find(p => String(p.items||'').includes(info.first_item));
        if(hit) found=hit;
      }

      const estado = (found && typeof found.estado!=='undefined' && found.estado!==null) ? String(found.estado) : 'Nuevo';
      setEstadoPill(estado);

      if(estado==='Entregado'){
        showToast('¡Tu pedido fue entregado! 🎉','ok');
        clearLastTrack(); // se oculta para el cliente
        stopTracking();
      }
    }catch(err){
      // silencioso, puede ser CORS
      // console.warn('track error', err);
    }
  }

  function startTracking(){
    const info=getLastTrack();
    const box=document.getElementById('trackBox');
    const idEl=document.getElementById('trackId');
    const openEl=document.getElementById('trackOpen');
    const btnRef=document.getElementById('trackRefresh');
    if(!info || !box || !idEl || !openEl) return;
    idEl.textContent=info.order_id || '—';
    openEl.href = TRACK_PANEL_URL; // abre el panel (admin); si preferís, después creamos vista pública
    setEstadoPill('Nuevo');
    box.hidden=false;
    if(btnRef){ btnRef.onclick = fetchTrackAndRender; }
    stopTracking();
    TRACK_TIMER = setInterval(fetchTrackAndRender, 7000);
    fetchTrackAndRender();
  }
  function stopTracking(){ if(TRACK_TIMER){ clearInterval(TRACK_TIMER); TRACK_TIMER=null; } }

  /* ======= WhatsApp (y registrar en hoja) ======= */
  function enviarPedido(){
    const nombreEl=document.getElementById('nombre');
    const name=nombreEl.value.trim(),addr=document.getElementById('direccion').value.trim();
    const envioInput=document.querySelector('input[name=envio]:checked');
    const segmented = document.querySelector('.segmented');

    if(!envioInput){
      const wrap = document.getElementById('toastWrap');
      wrap.style.bottom = window.sheetOpen ? 'calc(100vh - 76vh)' : '84px';
      showToast('📦 Seleccioná Retiro o Envío', 'error');
      if(segmented){
        segmented.style.boxShadow = '0 0 0 3px rgba(255, 204, 0, 0.6)';
        segmented.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(()=> segmented.style.boxShadow = '', 1500);
      }
      return;
    }

    const envio=envioInput.value;
    if(!name){showToast('Ingresá tu nombre','error');return}
    if(countItems()===0){showToast('Seleccioná al menos un producto','error');return}
    if(envio==='envio'&&!addr){showToast('Ingresá tu dirección para el envío','error');return}

    const itemsPorSeccion = { rotiseria:0, bebidas:0 };
    Object.entries(cantidades).forEach(([id,qty])=>{ if(qty>0) itemsPorSeccion[seccionDeId(id)] += qty; });
    if((itemsPorSeccion.rotiseria>0 && seccionCerradaAhora('rotiseria')) ||
       (itemsPorSeccion.bebidas>0   && seccionCerradaAhora('bebidas'))){
      actualizarResumen();
      showToast('Hay productos de una sección cerrada.','error');
      return;
    }

    let msg=`Hola, soy ${name}. Quiero hacer un pedido:\n`;
    const items=[];
    let firstItemName='';
    Object.entries(cantidades).forEach(([id,qty])=>{
      if(qty>0){
        const span=document.getElementById(`cantidad-${id}`); if(!span) return;
        const row=span.closest('.producto');
        const n=row.dataset.nombre, p=parseInt(row.dataset.precio,10), line=p*qty;
        const pid=row.dataset.pid || id; // ← product_id
        if(!firstItemName) firstItemName=n;
        msg+=`- ${n} x${qty} - ${formatARS(line)}\n`;
        items.push({ product_id: pid, name:n, qty, unit_price:p, line_total:line });
      }
    });

    const subtotal = items.reduce((a,i)=>a+i.line_total,0);
    const shipping_cost = envio==='envio'?SHIPPING:0;
    const total = subtotal + shipping_cost;
    const order_id = 'W'+new Date().toISOString().replace(/[-:.TZ]/g,'').slice(0,14);

    msg+=envio==='envio'?`Envío a domicilio a: ${addr} (+${formatARS(SHIPPING)})\n`:'Retiro en el local\n';
    msg+=`Total: ${formatARS(total)}`;

    // Registrar en Apps Script -> Hoja "Pedidos"
    logEvent('order_wsp',{ order_id, shipping:envio, shipping_cost, subtotal, total, name, address:addr, items });

    // Guardar “último pedido” para seguimiento
    try{ saveLastTrack({ order_id, name, first_item:firstItemName, created_at:Date.now() }); }catch{}

    // Enviar analíticas inmediatamente (no bloquea)
    flushEvents('order');

    // Abrir WhatsApp
    window.open(`https://wa.me/${WSP_NUMBER}?text=${encodeURIComponent(msg)}`,'_blank');
    showToast('Abriendo WhatsApp...','ok');

    // Vaciar carrito tras enviar
    Object.keys(cantidades).forEach(k=>cantidades[k]=0);
    document.querySelectorAll('[id^="cantidad-"]').forEach(el=>el.textContent='0');
    saveCart(cantidades);
    actualizarResumen();
    closeSheet(); // cerrar el sheet del carrito
    showToast('Pedido enviado. Carrito vaciado ✅','ok',2000);

    // Mostrar el box de seguimiento (debajo del listado)
    startTracking();
  }

  /* ======= Sheet (abrir/cerrar con focus trap) ======= */
  const sheet=document.getElementById('cartSheet'), sheetClose=document.getElementById('sheetClose'), backdrop=document.getElementById('sheetBackdrop');
  window.sheetOpen=false;
  function trapFocus(e){
    if(!window.sheetOpen||e.key!=='Tab')return;
    const f=sheet.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"]');
    if(!f.length)return;const first=f[0],last=f[f.length-1];
    if(e.shiftKey&&document.activeElement===first){e.preventDefault();last.focus()}
    else if(!e.shiftKey&&document.activeElement===last){e.preventDefault();first.focus()}
  }
  function openSheet(){
    if(window.sheetOpen)return;window.sheetOpen=true;document.body.style.overflow='hidden';
    sheet.classList.add('open');backdrop.classList.add('open');setFabVisible(false);
    setTimeout(()=>sheetClose.focus(),10);
    document.addEventListener('keydown',trapFocus);
    actualizarPasos();
    logEvent('sheet_open');
  }
  function closeSheet(){
    if(!window.sheetOpen)return;window.sheetOpen=false;document.body.style.overflow='';
    sheet.classList.remove('open');backdrop.classList.remove('open');
    actualizarResumen();document.removeEventListener('keydown',trapFocus);
    logEvent('sheet_close');
  }
  document.getElementById('cartFab').addEventListener('click',e=>{e.preventDefault();openSheet()});
  sheetClose.addEventListener('click',closeSheet);
  backdrop.addEventListener('click',closeSheet);

  /* ======= Pasos (Datos → Resumen → WhatsApp) ======= */
  function actualizarPasos(){
    const steps = document.querySelectorAll('#checkoutSteps .step');
    if(!steps.length) return;
    const envioInput = document.querySelector('input[name=envio]:checked');
    const datosOk = document.getElementById('nombre').value.trim().length>0 && !!envioInput &&
                    (envioInput.value==='retiro' || document.getElementById('direccion').value.trim().length>0);
    const hayItems = countItems()>0;
    let activo = 1; if(datosOk) activo = 2; if(datosOk && hayItems) activo = 3;
    steps.forEach(s=>{ s.classList.toggle('active', Number(s.dataset.step)===activo); });
  }

  /* ======= FAB hide al llegar a promo ======= */
  (function fabScrollHide(){
    const sentinel=document.querySelector('.promo-web');
    if(!sentinel)return;
    const io=new IntersectionObserver(entries=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){ document.getElementById('cartFab').classList.add('hide'); }
        else{
          if(countItems()>0 && !window.sheetOpen){
            const f=document.getElementById('cartFab');
            f.removeAttribute('hidden'); f.classList.remove('hide');
          }
        }
      });
    },{threshold:0});
    io.observe(sentinel);
  })();

  /* ======= Promo mail link ======= */
  (function promoInit(){
    const subj=encodeURIComponent('Quiero una web para mi negocio');
    const body=encodeURIComponent(`Hola Ludmila,\nVi tu trabajo y quiero pedir un presupuesto para mi web.\n\nTipo de sitio: (catálogo / pedidos / restaurante / otro)\n¿Panel para editar productos?: (sí/no)\n¿Plazo ideal?: (fecha)\n\n¡Gracias!`);
    const mailEl=document.getElementById('promoMail');
    if(mailEl){
      mailEl.href=`mailto:ludmilasolutions2.0@gmail.com?subject=${subj}&body=${body}`;
      mailEl.addEventListener('click',()=>logEvent('promo_mail_click'));
    }
  })();

  // Refrescar tabs cada minuto por cambios de horario + page_view + reiniciar tracking si existe
  window.addEventListener('DOMContentLoaded', ()=>{
    actualizarTabsPorHorario();
    setInterval(actualizarTabsPorHorario, 60*1000);
    logEvent('page_view',{title:document.title});
    if(getLastTrack()){ startTracking(); }
  });
  </script>
</body>
</html>
